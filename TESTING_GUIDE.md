# 视频处理API测试指南

## 概述

本项目提供了完整的测试套件，包括Gradio Web界面、单元测试、集成测试和测试运行器。这些工具可以帮助您全面测试视频处理API的各种功能。

## 🌐 Gradio Web测试界面

### 快速启动

1. **安装依赖**:
   ```bash
   pip install -r requirements_test.txt
   ```

2. **启动API服务器**:
   ```bash
   python api.py
   ```

3. **启动Gradio界面**:
   ```bash
   python gradio_test_interface.py
   ```

4. **访问界面**: 在浏览器中打开 http://localhost:7860

### 界面功能

#### 🏠 系统状态
- **API健康检查**: 检查API服务是否正常运行
- **系统资源状态**: 查看CPU、内存、磁盘使用情况
- **任务列表**: 查看所有活跃和历史任务

#### 📝 视频转录
- 输入YouTube、Bilibili等视频URL
- 自动识别语言并转录为文字
- 支持SRT字幕格式输出
- 实时查看转录进度

#### ⬇️ 视频下载
- 支持多种质量选项 (480p, 720p, 1080p, best, worst)
- 支持多种格式 (mp4, webm, mkv)
- 自动选择最佳下载源
- 显示下载进度和文件信息

#### 🖼️ 关键帧提取
- **间隔模式**: 按时间间隔提取关键帧
- **数量模式**: 提取指定数量的关键帧
- **关键帧模式**: 自动检测场景变化提取关键帧
- 可自定义图片尺寸和质量

#### 🎬 视频合成
- **concat**: 视频拼接 - 将多个视频按顺序连接
- **audio_video_subtitle**: 音频视频字幕合成
- **pip**: 画中画 - 视频叠加效果
- **side_by_side**: 并排显示多个视频
- **slideshow**: 幻灯片制作
- 支持音频文件和字幕文件上传

#### 🔍 任务查询
- 使用任务ID查询任务状态
- 实时显示处理进度
- 支持自动刷新功能
- 显示详细的错误信息

## 🧪 单元测试

### 运行单元测试

```bash
python test_unit_tests.py
```

### 测试内容

- **API健康检查**: 验证基本服务状态
- **输入验证**: 测试各种无效输入的处理
- **资源监控**: 验证资源监控端点
- **任务管理**: 测试任务生命周期管理
- **错误处理**: 验证错误处理机制
- **并发处理**: 测试并发请求处理能力

## 🔗 集成测试

### 运行集成测试

```bash
python test_integration_tests.py
```

### 测试内容

- **完整工作流程**: 测试端到端的API工作流程
- **并发处理**: 验证系统并发处理能力
- **资源管理**: 测试资源限制和清理功能
- **错误恢复**: 验证系统错误恢复机制
- **系统弹性**: 测试系统对异常情况的处理

## 🚀 统一测试运行器

### 运行所有测试

```bash
python run_all_tests.py
```

### 只启动Gradio界面

```bash
python run_all_tests.py --gradio-only
```

### 不启动Gradio界面

```bash
python run_all_tests.py --no-gradio
```

### 功能特性

- **自动检查API服务器状态**
- **并行运行多种测试**
- **生成详细的测试报告**
- **自动启动Gradio界面**
- **统计测试结果和成功率**

## 📊 测试报告

运行测试后会生成 `test_report.md` 文件，包含：

- 测试概览和统计信息
- 各类测试的详细结果
- 失败测试的错误信息
- 性能指标和建议
- 使用指南和故障排除

## 🔧 故障排除

### 常见问题

1. **API服务器不可用**
   ```bash
   # 检查API服务器是否启动
   curl http://localhost:8000/health
   
   # 启动API服务器
   python api.py
   ```

2. **Gradio界面无法访问**
   ```bash
   # 检查端口是否被占用
   lsof -i :7860
   
   # 重新启动界面
   python gradio_test_interface.py
   ```

3. **测试失败**
   - 确保API服务器正在运行
   - 检查网络连接
   - 查看详细错误信息
   - 检查系统资源是否充足

4. **依赖问题**
   ```bash
   # 安装测试依赖
   pip install -r requirements_test.txt
   
   # 检查Python版本 (需要3.8+)
   python --version
   ```

### 性能优化建议

1. **系统资源**
   - 确保有足够的内存 (建议8GB+)
   - 保持足够的磁盘空间 (建议10GB+)
   - 避免在高负载时运行测试

2. **网络环境**
   - 使用稳定的网络连接
   - 考虑使用本地测试文件
   - 避免在网络高峰期测试

3. **并发设置**
   - 根据系统性能调整并发任务数
   - 监控资源使用情况
   - 必要时降低测试并发度

## 📝 自定义测试

### 添加新的测试用例

1. **单元测试**: 在 `test_unit_tests.py` 中添加新的测试方法
2. **集成测试**: 在 `test_integration_tests.py` 中添加新的测试类
3. **Gradio界面**: 在 `gradio_test_interface.py` 中添加新的标签页

### 测试最佳实践

- 使用描述性的测试名称
- 包含适当的断言和验证
- 处理异常情况和边界条件
- 提供清晰的错误消息
- 确保测试的独立性和可重复性

## 🎯 测试策略

### 开发阶段
- 频繁运行单元测试
- 使用Gradio界面进行交互式测试
- 关注代码覆盖率

### 集成阶段
- 运行完整的集成测试套件
- 测试各种边界条件
- 验证错误处理机制

### 部署前
- 运行所有测试套件
- 检查性能指标
- 验证系统稳定性

## 📞 技术支持

如果遇到问题，可以：

1. 查看测试报告中的详细错误信息
2. 检查API服务器日志
3. 使用Gradio界面进行交互式调试
4. 查看系统资源使用情况
5. 参考本文档的故障排除部分

## 🔄 持续改进

测试套件会持续更新和改进：

- 添加新的测试用例
- 优化测试性能
- 改进用户界面
- 增强错误处理
- 扩展功能覆盖

建议定期更新测试套件以确保与API功能保持同步。